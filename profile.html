<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .profile-section {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer; /* Add cursor pointer for interaction */
            margin-right: 20px;
        }
        .profile-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .upload-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .upload-button img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .profile-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .profile-info input[type="text"], 
        .profile-info select,
        .profile-info input[type="date"] {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }
        .save-button {
            cursor: pointer;
            background-color: #000;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            width: 100px;
            text-align: center;
        }
        .save-button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div class="profile-section">
        <div class="profile-image" id="profile-image">
            <img src="https://img.icons8.com/ios-filled/100/000000/user.png" alt="Profile">
        </div>
        <div class="profile-info" id="profile-info">
            <input type="text" id="name" placeholder="Name">
            <select id="gender">
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
            </select>
            <input type="date" id="born-date">
            <button class="save-button" id="save-button">Save</button>
        </div>
    </div>

    <div class="upload-button" id="upload-button">
        <img src="https://img.icons8.com/material-rounded/24/000000/upload--v1.png" alt="Upload">
        Upload Photo
    </div>

    <!-- Firebase JavaScript SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_SwraEEOVgPEY4LeWj5BFCEnp0ISBMqI",
            authDomain: "cloudysocial-2cf2f.firebaseapp.com",
            databaseURL: "https://cloudysocial-2cf2f-default-rtdb.firebaseio.com",
            projectId: "cloudysocial-2cf2f",
            storageBucket: "cloudysocial-2cf2f.appspot.com",
            messagingSenderId: "423797592083",
            appId: "1:423797592083:web:e88ce69745e9335b2f6fe6",
            measurementId: "G-0LP83EFY37"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Profile image element
        const profileImage = document.getElementById('profile-image').firstElementChild;

        // Profile info elements
        const nameInput = document.getElementById('name');
        const genderSelect = document.getElementById('gender');
        const bornDateInput = document.getElementById('born-date');
        const saveButton = document.getElementById('save-button');

        // Check if user is authenticated
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Fetch latest profile photo URL from database
                db.ref('profilesphoto').orderByChild('uploaderEmail').equalTo(user.email).limitToLast(1).once('value').then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        if (data && data.photoUrl) {
                            profileImage.src = data.photoUrl;
                        }
                    });
                }).catch(error => {
                    console.error("Error fetching profile photo:", error);
                });

                // Fetch latest name, gender, and birthdate from respective nodes
                fetchLatestInfo('names', user.email, nameInput, 'name');
                fetchLatestInfo('gender', user.email, genderSelect, 'gender');
                fetchLatestInfo('borndate', user.email, bornDateInput, 'borndate');

                // Save profile info on button click
                saveButton.addEventListener('click', () => {
                    const name = nameInput.value.trim();
                    const gender = genderSelect.value;
                    const bornDate = bornDateInput.value;

                    if (name || gender || bornDate) {
                        saveProfileInfo(user.email, name, 'names');
                        saveProfileInfo(user.email, gender, 'gender');
                        saveProfileInfo(user.email, bornDate, 'borndate');
                    }
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // Function to fetch latest info from database
        function fetchLatestInfo(node, email, element, field) {
            db.ref(node).orderByChild('email').equalTo(email).limitToLast(1).once('value').then(snapshot => {
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data && data[field]) {
                        element.value = data[field];
                        element.dataset.key = childSnapshot.key; // Store key for updates
                    }
                });
            }).catch(error => {
                console.error(`Error fetching ${field}:`, error);
            });
        }

        // Function to save profile info to database
        function saveProfileInfo(email, value, node) {
            const timestamp = Date.now();
            const key = document.getElementById(node).dataset.key || db.ref(node).push().key;
            const updates = {};
            updates[`${node}/${key}`] = { email, [node === 'borndate' ? 'borndate' : node]: value, timestamp };
            db.ref().update(updates).then(() => {
                console.log(`${node} updated successfully.`);
            }).catch(error => {
                console.error(`Error updating ${node}:`, error);
            });
        }

        // Handle click on profile image to trigger file input click
        profileImage.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const user = auth.currentUser;
                    if (user) {
                        const timestamp = Date.now();
                        const storageRef = storage.ref(`profilesphoto/${timestamp}-${file.name}`);
                        storageRef.put(file).then(snapshot => {
                            return snapshot.ref.getDownloadURL();
                        }).then(url => {
                            // Save photo URL to database
                            const newPhotoRef = db.ref('profilesphoto').push();
                            newPhotoRef.set({
                                uploaderEmail: user.email,
                                photoUrl: url,
                                timestamp: timestamp
                            });
                            // Update profile image
                            profileImage.src = url;
                        }).catch(error => {
                            console.error("Error uploading file:", error);
                        });
                    }
                }
            };
            fileInput.click();
        });
    </script>
</body>
</html>
